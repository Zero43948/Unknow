--// Điểu Nhân Aimlock | Universal | Mobile + PC

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local LP = Players.LocalPlayer
local Camera = workspace.CurrentCamera
repeat task.wait() until LP.Character and Camera

--================ CONFIG =================--
local Prediction = 0.13
local Smoothness = 0.46
local MaxFOV = 190
local AimFPS_ON = 60        -- máy yếu: 45
--========================================--

local AimON = false
local FixLagEnabled = false
local Target = nil
local acc = 0
local lastPredicted = nil

--================ GUI =================--
local gui = Instance.new("ScreenGui")
gui.Name = "DieuNhanUI"
gui.ResetOnSpawn = false
pcall(function() gui.Parent = game:GetService("CoreGui") end)
if not gui.Parent then gui.Parent = LP:WaitForChild("PlayerGui") end

--================ BUTTON =================--
local btn = Instance.new("TextButton", gui)
btn.Size = UDim2.new(0,170,0,44)
btn.Position = UDim2.new(0.6,0,0.25,0)
btn.Text = "   Điểu Nhân OFF"
btn.TextScaled = true
btn.Font = Enum.Font.GothamBold
btn.TextColor3 = Color3.fromRGB(0,255,255)
btn.BackgroundColor3 = Color3.fromRGB(15,15,15)
btn.BorderSizePixel = 0
btn.Active = true

Instance.new("UICorner", btn).CornerRadius = UDim.new(0,10)
local stroke = Instance.new("UIStroke", btn)
stroke.Thickness = 2
stroke.Color = Color3.fromRGB(130,130,130)
stroke.Transparency = 0.25

local icon = Instance.new("ImageLabel", btn)
icon.Size = UDim2.new(0,26,0,26)
icon.Position = UDim2.new(0,8,0.5,-13)
icon.BackgroundTransparency = 1
icon.Image = "rbxassetid://7733960981"
icon.ImageTransparency = 0.3

--================ DRAG =================--
local dragging, dragStart, startPos
btn.InputBegan:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.Touch or i.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true; dragStart = i.Position; startPos = btn.Position
	end
end)
btn.InputChanged:Connect(function(i)
	if dragging and (i.UserInputType == Enum.UserInputType.Touch or i.UserInputType == Enum.UserInputType.MouseMovement) then
		local d = i.Position - dragStart
		btn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + d.X, startPos.Y.Scale, startPos.Y.Offset + d.Y)
	end
end)
btn.InputEnded:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.Touch or i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
end)

--================ FPS =================--
local fpsLabel = Instance.new("TextLabel", gui)
fpsLabel.Size = UDim2.new(0,110,0,26)
fpsLabel.Position = UDim2.new(0.02,0,0.02,0)
fpsLabel.BackgroundColor3 = Color3.fromRGB(15,15,15)
fpsLabel.TextColor3 = Color3.fromRGB(0,255,0)
fpsLabel.TextScaled = true
fpsLabel.Font = Enum.Font.GothamBold
fpsLabel.BorderSizePixel = 0
fpsLabel.Visible = false
Instance.new("UICorner", fpsLabel).CornerRadius = UDim.new(0,8)

local frames = 0
RunService.RenderStepped:Connect(function() frames += 1 end)
task.spawn(function()
	while true do
		fpsLabel.Text = "FPS: "..frames
		frames = 0
		task.wait(1)
	end
end)

--================ FIX LAG LABEL (BOTTOM RIGHT) =================--
local fixLagLabel = Instance.new("TextLabel", gui)
fixLagLabel.Size = UDim2.new(0,120,0,22)
fixLagLabel.Position = UDim2.new(1,-130,1,-30)
fixLagLabel.BackgroundTransparency = 1
fixLagLabel.Text = "Fix Lag: ON"
fixLagLabel.TextColor3 = Color3.fromRGB(0,255,170)
fixLagLabel.TextScaled = true
fixLagLabel.Font = Enum.Font.GothamBold
fixLagLabel.TextStrokeTransparency = 0.6
fixLagLabel.TextStrokeColor3 = Color3.fromRGB(0,0,0)
fixLagLabel.Visible = false
fixLagLabel.ZIndex = 10

--================ TOGGLE =================--
btn.MouseButton1Click:Connect(function()
	AimON = not AimON
	if AimON then
		FixLagEnabled = true
		btn.Text = "   Điểu Nhân ON"
		stroke.Color = Color3.fromRGB(0,255,255)
		stroke.Transparency = 0
		icon.ImageTransparency = 0
		fpsLabel.Visible = true
		fixLagLabel.Visible = true
	else
		FixLagEnabled = false
		Target = nil
		lastPredicted = nil
		btn.Text = "   Điểu Nhân OFF"
		stroke.Color = Color3.fromRGB(130,130,130)
		stroke.Transparency = 0.25
		icon.ImageTransparency = 0.3
		fpsLabel.Visible = false
		fixLagLabel.Visible = false
	end
end)

--================ TARGET =================--
local function GetClosest()
	local closest, dist = nil, MaxFOV
	for _,plr in pairs(Players:GetPlayers()) do
		if plr ~= LP and plr.Character
		and plr.Character:FindFirstChild("HumanoidRootPart")
		and plr.Character:FindFirstChild("Humanoid")
		and plr.Character.Humanoid.Health > 0 then
			local pos, onScreen = Camera:WorldToViewportPoint(plr.Character.HumanoidRootPart.Position)
			if onScreen then
				local mag = (Vector2.new(pos.X,pos.Y) -
					Vector2.new(Camera.ViewportSize.X/2,Camera.ViewportSize.Y/2)).Magnitude
				if mag < dist then dist = mag; closest = plr end
			end
		end
	end
	return closest
end

--================ AIM LOOP (FIX LAG WHEN ON) =================--
RunService.RenderStepped:Connect(function(dt)
	if FixLagEnabled then
		acc += dt
		if acc < (1 / AimFPS_ON) then return end
		acc = 0
	end
	if not AimON then return end

	if not Target then Target = GetClosest() end
	if not Target or not Target.Character then Target = nil return end

	local char = Target.Character
	local hrp = char:FindFirstChild("HumanoidRootPart")
	local hum = char:FindFirstChild("Humanoid")
	if not hrp or not hum or hum.Health <= 0 then Target = nil return end

	-- Smart hitbox (head when ổn định, torso khi chạy nhanh)
	local vel = hrp.Velocity
	local speed = vel.Magnitude
	local aimPart = hrp
	if speed < 12 and char:FindFirstChild("Head") then
		aimPart = char.Head
	elseif char:FindFirstChild("UpperTorso") then
		aimPart = char.UpperTorso
	end

	-- Dynamic prediction
	local dynPred = Prediction
	if speed < 2 then dynPred = Prediction * 0.6
	elseif speed > 8 then dynPred = Prediction * 1.25 end

	local predicted = aimPart.Position + vel * dynPred

	-- Anti-jitter
	if lastPredicted then
		predicted = lastPredicted:Lerp(predicted, 0.7)
	end
	lastPredicted = predicted

	-- Dynamic smooth
	local camPos = Camera.CFrame.Position
	local dist = (predicted - camPos).Magnitude
	local dynSmooth = Smoothness
	if dist < 18 then dynSmooth = Smoothness * 0.6
	elseif dist < 30 then dynSmooth = Smoothness * 0.8 end

	Camera.CFrame = Camera.CFrame:Lerp(CFrame.new(camPos, predicted), dynSmooth)
end)
